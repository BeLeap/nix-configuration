name: Build flake outputs

on:
  pull_request:
  push:

jobs:
  build:
    name: build (${{ matrix.name }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: nixos-vm-arm64-Darwin-personal
            runner: ubuntu-latest
            flake_attr: .#nixosConfigurations.vm-arm64-Darwin-personal.config.system.build.toplevel
          - name: nixos-vm-arm64-Darwin-work
            runner: ubuntu-latest
            flake_attr: .#nixosConfigurations.vm-arm64-Darwin-work.config.system.build.toplevel
          - name: darwin-beleap-m1air
            runner: macos-latest
            flake_attr: .#darwinConfigurations.beleap-m1air.system
          - name: darwin-csjang-m3pro
            runner: macos-latest
            flake_attr: .#darwinConfigurations.csjang-m3pro.system

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Build flake output
        id: build
        continue-on-error: true
        run: |
          set -o pipefail
          nix build "${{ matrix.flake_attr }}" 2>&1 | tee build.log
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"

      - name: Comment failure on PR or commit
        if: steps.build.outputs.exit_code != '0'
        uses: actions/github-script@v7
        env:
          BUILD_NAME: ${{ matrix.name }}
          FLAKE_ATTR: ${{ matrix.flake_attr }}
        with:
          script: |
            const fs = require("fs");
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const buildName = process.env.BUILD_NAME;
            const flakeAttr = process.env.FLAKE_ATTR;
            let log = "";
            try {
              log = fs.readFileSync("build.log", "utf8");
            } catch (error) {
              log = `Unable to read build log: ${error.message}`;
            }
            const maxLength = 65000;
            if (log.length > maxLength) {
              log = log.slice(-maxLength);
            }
            const body = [
              `‚ùå Flake build failed for **${buildName}**.`,
              ``,
              `Attribute: \`${flakeAttr}\``,
              ``,
              "```",
              log,
              "```",
            ].join("\n");
            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: context.payload.pull_request.number,
                body,
              });
            } else {
              await github.rest.repos.createCommitComment({
                owner,
                repo,
                commit_sha: context.sha,
                body,
              });
            }
